---
- name: Install Nix.
  become: true
  block:
    - name: Install nix-setup-systemd.
      ansible.builtin.apt:
        name: nix-setup-systemd
        state: present

    - name: Add nixpkgs repository.
      ansible.builtin.lineinfile:
        path: /root/.nix-channels
        regexp: '^\s*[^#\s][^ ]+ nixpkgs$'
        line: https://nixos.org/channels/nixpkgs-unstable nixpkgs
        mode: '0644'
        create: true
        state: present
      register: add_nixpkgs

    - name: Update nix repositories.
      ansible.builtin.command:
        cmd: nix-channel --update
      when: add_nixpkgs.changed

    # this is needed because the alteration of PATHs in environment.d do not work
    - name: Add Nix's binary paths to PATH.
      ansible.builtin.copy:
        dest: /etc/profile.d/add-nix-bin-paths.sh
        content: |
          nix_bin_paths="$HOME/.nix-profile/bin:/nix/var/nix/profiles/default/bin"
          if [ -n "${PATH##*${nix_bin_paths}}" ] && [ -n "${PATH##*${nix_bin_paths}:*}" ]; then
              export PATH="${nix_bin_paths}:$PATH"
          fi
        mode: '0644'
